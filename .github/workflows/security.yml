name: Security

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
  schedule:
    # Run weekly on Wednesday at 6:00 UTC
    - cron: "0 6 * * 3"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  # Scan dependencies for known vulnerabilities on PRs
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.7.1
        with:
          config-file: .github/dependency-review-config.yml
          fail-on-severity: high
          comment-summary-in-pr: always

  # Static analysis for Python
  script-security:
    name: Script Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443
            uploads.github.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5.5.0
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run Bandit security scanner
        run: |
          echo "Running Bandit security scanner..."
          bandit -r . -x ./tests,./.venv -f sarif -o bandit-results.sarif || true
          bandit -r . -x ./tests,./.venv -ll
          echo "Security scan complete"

      - name: Upload Bandit SARIF to Security tab
        uses: github/codeql-action/upload-sarif@7434149006143a4d75b82a2f411ef15b03ccc2d7 # v4
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: bandit

      - name: Upload Bandit report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: bandit-security-report
          path: bandit-results.sarif
          if-no-files-found: ignore

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."

          PATTERNS=(
            'password\s*=\s*["\x27][^"\x27]+["\x27]'
            'api[_-]?key\s*=\s*["\x27][^"\x27]+["\x27]'
            'secret\s*=\s*["\x27][^"\x27]+["\x27]'
            'token\s*=\s*["\x27][^"\x27]+["\x27]'
          )

          ISSUES=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rEn "$pattern" --include="*.py" . 2>/dev/null | grep -v "os.getenv\|get_env_variable\|environ"; then
              echo "::warning::Potential hardcoded secret found matching pattern: $pattern"
              ISSUES=$((ISSUES + 1))
            fi
          done

          if [ $ISSUES -gt 0 ]; then
            echo "::error::Found $ISSUES potential hardcoded secret(s)"
            exit 1
          fi

          echo "No hardcoded secrets detected"

      - name: Check for unsafe patterns
        run: |
          echo "Checking for potentially unsafe patterns..."

          ISSUES=0

          # Check for eval usage
          if grep -rn "eval(" --include="*.py" . 2>/dev/null; then
            echo "::warning::Found eval() usage - can execute arbitrary code"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for exec usage
          if grep -rn "exec(" --include="*.py" . 2>/dev/null; then
            echo "::warning::Found exec() usage - can execute arbitrary code"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for shell=True in subprocess
          if grep -rn "shell=True" --include="*.py" . 2>/dev/null; then
            echo "::warning::Found shell=True in subprocess - potential command injection"
            ISSUES=$((ISSUES + 1))
          fi

          if [ $ISSUES -gt 0 ]; then
            echo "Found $ISSUES potentially unsafe pattern(s) - review recommended"
          else
            echo "No unsafe patterns detected"
          fi

  # Pip audit for known vulnerabilities
  pip-audit:
    name: Pip Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            api.osv.dev:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5.5.0
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run pip-audit
        run: |
          pip-audit --desc on
