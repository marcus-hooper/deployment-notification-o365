name: Scheduled Health Check

on:
  schedule:
    # Run weekly on Monday at 6:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    # Allow manual trigger for debugging

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  health-check:
    name: Script Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        shell: bash
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Validate action.yml
        shell: bash
        run: |
          echo "Validating action.yml..."
          python -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "action.yml is valid YAML"

      - name: Run linter
        shell: bash
        run: ruff check .

      - name: Run tests
        shell: bash
        run: pytest tests/ -v --junitxml=test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: health-check-test-results
          path: test-results.xml
          if-no-files-found: ignore
          retention-days: 14

  # Notify on failure by creating a GitHub issue
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: health-check
    if: failure() && github.event_name == 'schedule'
    timeout-minutes: 5

    permissions:
      issues: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Ensure health-check-failure label exists
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh label create "health-check-failure" --description "Automated health check detected a failure" --color "d73a4a" --force

      - name: Create failure issue
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # Check for existing open issue to avoid duplicates
          EXISTING=$(gh issue list --label "health-check-failure" --state open --json number --jq '.[0].number // empty')

          if [[ -n "$EXISTING" ]]; then
            echo "Existing issue #$EXISTING found, adding comment"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            gh issue comment "$EXISTING" --body "Health check failed again on $(date -u '+%Y-%m-%d %H:%M UTC'). [View workflow run]($RUN_URL)"
          else
            echo "Creating new failure issue"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            ISSUE_BODY="The scheduled health check workflow failed."
            ISSUE_BODY="$ISSUE_BODY"$'\n\n'"## Details"
            ISSUE_BODY="$ISSUE_BODY"$'\n'"- **Run URL:** $RUN_URL"
            ISSUE_BODY="$ISSUE_BODY"$'\n\n'"## Possible Causes"
            ISSUE_BODY="$ISSUE_BODY"$'\n'"- Python dependency installation failure"
            ISSUE_BODY="$ISSUE_BODY"$'\n'"- Import resolution errors (msgraph-sdk, azure-identity)"
            ISSUE_BODY="$ISSUE_BODY"$'\n'"- Linting or pytest failures"
            ISSUE_BODY="$ISSUE_BODY"$'\n\n'"Please investigate and resolve the issue."
            gh issue create \
              --title "Scheduled health check failed" \
              --label "health-check-failure,type:bug" \
              --body "$ISSUE_BODY"
          fi

  # Auto-close failure issues when health check passes
  notify-success:
    name: Close Stale Failure Issues
    runs-on: ubuntu-latest
    needs: health-check
    if: success() && github.event_name == 'schedule'
    timeout-minutes: 5

    permissions:
      issues: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Close stale failure issues
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh issue list --label "health-check-failure" --state open --json number --jq '.[].number' | while read -r issue; do
            if [[ -n "$issue" ]]; then
              echo "Closing issue #$issue"
              gh issue close "$issue" --comment "Health check is passing again as of $(date -u '+%Y-%m-%d %H:%M UTC'). Closing automatically."
            fi
          done
          echo "Done processing stale failure issues"
