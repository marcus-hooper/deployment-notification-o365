name: Scheduled Health Check

on:
  schedule:
    # Run weekly on Monday at 6:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    # Allow manual trigger for debugging

permissions:
  contents: read

jobs:
  health-check:
    name: Script Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify script syntax
        run: |
          echo "Checking Python syntax..."
          python -m py_compile send_deployment_notification.py
          echo "Syntax check passed"

      - name: Verify imports
        run: |
          echo "Verifying all imports can be resolved..."
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Test all imports from the main script
          from azure.identity import ClientSecretCredential
          from msgraph import GraphServiceClient
          from msgraph.generated.users.item.send_mail.send_mail_post_request_body import SendMailPostRequestBody
          from msgraph.generated.models.message import Message
          from msgraph.generated.models.item_body import ItemBody
          from msgraph.generated.models.body_type import BodyType
          from msgraph.generated.models.recipient import Recipient
          from msgraph.generated.models.email_address import EmailAddress
          import asyncio
          import datetime
          import os
          import logging
          import pytz

          print('All imports resolved successfully')
          "

      - name: Verify utility functions
        run: |
          echo "Testing utility functions..."
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Import the module
          import send_deployment_notification as script

          # Test get_formatted_time
          time_str = script.get_formatted_time()
          assert time_str is not None, 'get_formatted_time returned None'
          assert len(time_str) > 0, 'get_formatted_time returned empty string'
          print(f'get_formatted_time: OK ({time_str})')

          # Test prepare_email_content
          subject, content = script.prepare_email_content('test/repo', 'production', 'testuser')
          assert 'test/repo' in subject, 'Repository not in subject'
          assert 'production' in content, 'Environment not in content'
          assert 'testuser' in content, 'Actor not in content'
          print('prepare_email_content: OK')

          # Test prepare_recipients
          recipients = script.prepare_recipients('user1@example.com, user2@example.com')
          assert len(recipients) == 2, f'Expected 2 recipients, got {len(recipients)}'
          print('prepare_recipients: OK')

          print('All utility function tests passed')
          "

      - name: Validate action.yml
        run: |
          echo "Validating action.yml..."
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "action.yml is valid YAML"

      - name: Run linter
        run: |
          pip install ruff
          ruff check . || echo "::warning::Linting issues found"

      - name: Run tests (if available)
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests/*.py 2>/dev/null)" ]; then
            pip install pytest pytest-asyncio
            pytest tests/ -v
          else
            echo "No tests found - skipping"
          fi
