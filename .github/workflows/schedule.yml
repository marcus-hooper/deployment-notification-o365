name: Scheduled Health Check

on:
  schedule:
    # Run weekly on Monday at 6:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    # Allow manual trigger for debugging
    inputs:
      skip_issue_creation:
        description: "Skip creating/updating GitHub issues on failure"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  health-check:
    name: Script Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        id: install-deps
        shell: bash
        timeout-minutes: 5
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Validate action.yml
        id: validate-action
        shell: bash
        timeout-minutes: 1
        run: |
          echo "Validating action.yml..."
          python -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "action.yml is valid YAML"

      - name: Run linter
        id: lint
        shell: bash
        timeout-minutes: 2
        run: ruff check .

      - name: Run tests
        id: test
        shell: bash
        timeout-minutes: 5
        run: pytest tests/ -v --junitxml=test-results.xml

      - name: Write workflow summary
        if: always()
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## Health Check Results

          | Check | Status |
          |-------|--------|
          | Python setup | ${{ steps.setup-python.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Dependencies | ${{ steps.install-deps.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | action.yml validation | ${{ steps.validate-action.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Ruff linter | ${{ steps.lint.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Pytest | ${{ steps.test.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |

          **Workflow run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: health-check-test-results
          path: test-results.xml
          if-no-files-found: ignore
          retention-days: 14

  # Notify on failure by creating a GitHub issue
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: health-check
    if: failure() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.skip_issue_creation))
    timeout-minutes: 5

    permissions:
      issues: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Ensure status:health-check-failure label exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          gh label create "status:health-check-failure" --description "Automated health check detected a failure" --color "d73a4a" --force

      - name: Create failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_BODY: |
            The scheduled health check workflow failed.

            ## Details
            - **Workflow:** Scheduled Health Check
            - **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Possible Causes
            - Python dependency installation failure
            - Import resolution errors (msgraph-sdk, azure-identity)
            - Linting or pytest failures

            Please investigate and resolve the issue.
        run: |
          set -euo pipefail
          # Check for existing open issue to avoid duplicates
          EXISTING=$(gh issue list --label "status:health-check-failure" --state open --json number --jq '.[0].number // empty')

          if [[ -n "$EXISTING" ]]; then
            echo "Existing issue #$EXISTING found, adding comment"
            gh issue comment "$EXISTING" --body "Health check failed again on $(date -u '+%Y-%m-%d %H:%M UTC'). [View workflow run]($RUN_URL)"
          else
            echo "Creating new failure issue"
            gh issue create \
              --title "Scheduled health check failed" \
              --label "status:health-check-failure,type:bug" \
              --body "$ISSUE_BODY"
          fi

  # Auto-close failure issues when health check passes
  notify-success:
    name: Close Stale Failure Issues
    runs-on: ubuntu-latest
    needs: health-check
    if: success() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.skip_issue_creation))
    timeout-minutes: 5

    permissions:
      issues: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Close stale failure issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          issues=$(gh issue list --label "status:health-check-failure" --state open --json number --jq '.[].number' || true)
          if [[ -n "$issues" ]]; then
            while read -r issue; do
              echo "Closing issue #$issue"
              gh issue close "$issue" --comment "Health check is passing again as of $(date -u '+%Y-%m-%d %H:%M UTC'). Closing automatically."
            done <<< "$issues"
          fi
          echo "Done processing stale failure issues"
