name: CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore: &paths-ignore
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore: *paths-ignore

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-changelog:
    name: Validate CHANGELOG
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Validate CHANGELOG format
        run: |
          echo "Validating CHANGELOG.md format..."
          if [[ ! -f CHANGELOG.md ]]; then
            echo "::error::CHANGELOG.md not found"
            exit 1
          fi
          if ! grep -qE "^## \[Unreleased\]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md missing '## [Unreleased]' section"
            exit 1
          fi
          echo "CHANGELOG.md format valid"

  lint:
    name: Ruff Linter
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run Ruff linter
        run: |
          ruff check . --output-format=github
          echo "Linting passed"

      - name: Run Ruff formatter check
        run: |
          ruff format --check .
          echo "Format check passed"

  type-check:
    name: Type Check
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run mypy
        run: |
          mypy send_deployment_notification.py --ignore-missing-imports
          echo "Type check passed"

  test:
    name: Run Tests
    needs: [lint, type-check]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      checks: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            cli.codecov.io:443
            codecov.io:443
            files.pythonhosted.org:443
            github.com:443
            ingest.codecov.io:443
            pypi.org:443
            storage.googleapis.com:443
            uploader.codecov.io:443

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run pytest
        run: pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          if-no-files-found: error
          retention-days: 14

      - name: Publish test results
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2.5.0
        if: always()
        with:
          name: Pytest Tests
          path: test-results.xml
          reporter: java-junit

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        if: always()
        with:
          files: coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Validate action.yml syntax
        run: |
          echo "Validating action.yml..."
          if [[ ! -f action.yml ]]; then
            echo "::error::action.yml not found"
            exit 1
          fi
          if ! yq eval '.' action.yml > /dev/null 2>&1; then
            echo "::error::action.yml is not valid YAML"
            exit 1
          fi
          echo "action.yml is valid YAML"

      - name: Validate action.yml structure
        run: |
          # Check for required composite action fields
          if ! yq eval '.name' action.yml > /dev/null 2>&1 || \
             [[ "$(yq eval '.name' action.yml)" == "null" ]]; then
            echo "::error::action.yml missing 'name' field"
            exit 1
          fi
          if ! yq eval '.runs.using' action.yml > /dev/null 2>&1 || \
             [[ "$(yq eval '.runs.using' action.yml)" != "composite" ]]; then
            echo "::error::action.yml missing 'runs.using: composite'"
            exit 1
          fi
          echo "action.yml structure valid"

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-changelog, lint, type-check, test, integration-test]

    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.validate-changelog.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.integration-test.result }}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully"
