name: CI

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore: &paths-ignore
      - 'README.md'
      - 'SECURITY.md'
      - 'docs/**'
      - '.github/*.md'
      - '.github/ISSUE_TEMPLATE/**'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore: *paths-ignore

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-changelog:
    name: Validate CHANGELOG
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Validate CHANGELOG format
        run: |
          echo "Validating CHANGELOG.md format..."
          if [[ ! -f CHANGELOG.md ]]; then
            echo "::error::CHANGELOG.md not found"
            exit 1
          fi
          if ! grep -qE "^## \[Unreleased\]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md missing '## [Unreleased]' section"
            exit 1
          fi
          echo "CHANGELOG.md format valid"

  lint:
    name: Ruff Linter
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run Ruff linter
        run: |
          ruff check . --output-format=github
          echo "Linting passed"

      - name: Run Ruff formatter check
        run: |
          ruff format --check .
          echo "Format check passed"

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run mypy
        run: |
          mypy send_deployment_notification.py --ignore-missing-imports
          echo "Type check passed"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            cli.codecov.io:443
            codecov.io:443
            files.pythonhosted.org:443
            github.com:443
            ingest.codecov.io:443
            pypi.org:443
            storage.googleapis.com:443
            uploader.codecov.io:443

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5.5.0
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt

      - name: Install dependencies
        run: pip install --require-hashes -r requirements-dev.txt

      - name: Run pytest
        run: pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
          if-no-files-found: error
          retention-days: 14

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-changelog, lint, type-check, test]

    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.validate-changelog.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully"
