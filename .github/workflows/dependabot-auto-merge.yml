name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  auto-merge:
    name: Auto-merge safe updates
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.actor == 'dependabot[bot]'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge patch and minor updates
        if: |
          steps.metadata.outputs.package-ecosystem != 'github_actions' &&
          (steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          echo "Auto-merging ${UPDATE_TYPE} update"
          echo "Package: ${DEPENDENCY_NAMES}"
          gh pr merge --auto --squash "$PR_URL" || echo "Auto-merge request failed or already pending"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type }}
          DEPENDENCY_NAMES: ${{ steps.metadata.outputs.dependency-names }}

      - name: Skip auto-merge for GitHub Actions updates
        if: steps.metadata.outputs.package-ecosystem == 'github_actions'
        run: |
          echo "GitHub Actions updates require manual merge (GITHUB_TOKEN cannot modify workflow files)"

          # Check if we already commented on this PR
          EXISTING_COMMENT=$(gh pr view "$PR_URL" --json comments --jq '.comments[].body' | grep -c "GitHub Actions update requires manual merge" || true)
          if [ "$EXISTING_COMMENT" -eq "0" ]; then
            gh pr comment "$PR_URL" --body "**GitHub Actions update requires manual merge**

This PR updates a GitHub Actions workflow dependency (**${DEPENDENCY_NAMES}**).

Due to GitHub security restrictions, the \`GITHUB_TOKEN\` cannot modify workflow files, so this PR cannot be auto-merged.

**Action required:** Please review and merge this PR manually."
          else
            echo "Comment already exists, skipping"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPENDENCY_NAMES: ${{ steps.metadata.outputs.dependency-names }}

      - name: Add label for major updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-major' &&
          steps.metadata.outputs.package-ecosystem != 'github_actions'
        run: |
          echo "Major update detected - requires manual review"
          gh pr edit "$PR_URL" --add-label "major-update,needs-review"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-major' &&
          steps.metadata.outputs.package-ecosystem != 'github_actions'
        run: |
          # Check if we already commented on this PR
          EXISTING_COMMENT=$(gh pr view "$PR_URL" --json comments --jq '.comments[].body' | grep -c "Major version update detected" || true)
          if [ "$EXISTING_COMMENT" -eq "0" ]; then
            gh pr comment "$PR_URL" --body "**Major version update detected**

This PR updates **${DEPENDENCY_NAMES}** to a new major version.

**Action required:**
1. Review the changelog for breaking changes
2. Test thoroughly before merging
3. Merge manually when ready

Major updates are not auto-merged for safety."
          else
            echo "Comment already exists, skipping"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPENDENCY_NAMES: ${{ steps.metadata.outputs.dependency-names }}
